---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 



```{r, echo=FALSE}
library(tidyverse)
library(dplyr)
library(tidyr)
library(openintro)
library(mediation)
library(splitstackshape)
library(gridExtra)
library(ggcorrplot)
library(car)
library(nortest)
library(MASS)
library(stargazer)
library(xtable)
library(lmtest)
```


```{r, echo=FALSE}
data <- read.csv("results_bachelorthesis.csv") %>% 
  dplyr::select(-Ereignissimulation, -Verlosung) %>% 
  rename(Gender = "ï..Geschlecht") %>% 
  rename(Age = "Alter") %>% 
  rename(Education = "Bildungsstand") 
  
   


data

```


```{r}

```


# Gesamtstatistik
(Also Durchschnittsalter, Schulabschluss, Gender)

```{r, echo=FALSE}
data_gender <- data %>% 
  dplyr::select(Gender) %>%
  group_by(Gender) %>% 
  dplyr::count(Gender) %>% 
  summarise(Anteil = round(100*n / sum(.$n), digits = 2)) %>% 
  mutate(Gender = case_when(
    Gender == "d" ~ "Diverse",
    Gender == "m" ~ "Male",
    Gender == "w" ~ "Female",
    Gender == "kA" ~ "Not specified"
  )) %>% 
  dplyr::arrange(desc(Anteil))
  

data_gender
```


```{r, echo=FALSE}
data_bildung <- data %>% 
  dplyr::select(Education) %>%
  group_by(Education) %>% 
  dplyr::count(Education) %>% 
  summarise(Anteil = round(100*n / sum(.$n), digits = 2)) %>% 
  dplyr::arrange(desc(Anteil)) %>% 
  mutate(Education = case_when(
    Education == "Abi" ~ "Alevels",
    Education == "AS" ~ "University Degree",
    Education == "Real" ~ "Secondary School (Realschule) ",
    Education == "Haupt" ~ "Secondary School (Hauptschule) ",
  ))

data_bildung
```
# Altersdurchschnitt und Standardabweichung

```{r}
data_age_mean <- na.omit(data$Age) %>% 
  mean() 

data_age_sd <- na.omit(data$Age) %>% 
  sd() 

data_age_mean
data_age_sd

```
# Was ist die Verteilung von Menschen, die Journaling betreiben?

```{r, echo=FALSE}


data_journal <- data %>% 
  dplyr::select(Journaling1) %>% 
  
  group_by(Journaling1) %>% 
  dplyr::count(Journaling1) %>% 
  summarise(Anteil = round(100*n / sum(.$n), digits = 2)) %>% 
  mutate(Journaling1 = case_when(
    Journaling1 == 1 ~ "Never",
    Journaling1 == 2 ~ "Seldom",
    Journaling1 == 3 ~ "Sometimes",
    Journaling1 == 4 ~ "Often",
    Journaling1 == 5 ~ "Very often",

    TRUE ~ as.character(Journaling1)  # Default case, no change
  ))  %>% 
  rename(Journaling_Häufigkeit = "Journaling1") %>% 
  dplyr::arrange(desc(Anteil))

data_journal


```
```{r, echo=FALSE}


data_journal3 <- data %>% 
  dplyr::select(Journaling3) %>% 
  
  group_by(Journaling3) %>% 
  dplyr::count(Journaling3) %>% 
  summarise(Anteil = round(100*n / sum(.$n), digits = 2)) %>% 
  mutate(Journaling3 = case_when(
    Journaling3 == 1 ~ "Never",
    Journaling3 == 2 ~ "More than a month ago",
    Journaling3 == 3 ~ "This month",
    Journaling3 == 4 ~ "This week",
    Journaling3 == 5 ~ "Today",

    TRUE ~ as.character(Journaling3)  # Default case, no change
  ))  %>% 
  rename(Journaling_last_entry = "Journaling3") %>% 
  dplyr::arrange(desc(Anteil))

data_journal3


```
# Vorbereitung Statistische Analysen 

```{r}
data_journaling <- data %>% 
  dplyr::select(-Journaling2)
journaling_columns <- grep("Journaling", names(data_journaling), value = TRUE)
counterfactual_columns <- grep("Counterfactuals", names(data), value = TRUE)
selfefficacy_columns <- grep("Selbstwirksamkeit", names(data), value = TRUE)

data
data$Journaling <- rowSums(data[c(journaling_columns)]) 
data$Counterfactuals <- rowSums(data[c(counterfactual_columns)]) 
data$SelfEfficacy <- rowSums(data[c(selfefficacy_columns)]) 


data_mediation <- data %>% 
  dplyr::select(Age, Gender, Education, Journaling, Counterfactuals, Selfefficacy) %>% 
   mutate(Education = case_when(
    Education == "Abi" ~ "Alevels",
    Education == "AS" ~ "University",
    Education == "Real" ~ "Realschule",
    Education == "Haupt" ~ "Hauptschule",
  )) %>% 
  mutate(Gender = case_when(
    Gender == "kA" ~ NA,
    Gender == "m" ~ "m",
    Gender == "w" ~ "f",
    Gender == "d" ~ "d"
  )) 

data_mediation
  
```



# Analyse, ob Menschen, die zuletzt heute gejournalt haben, auch mehr Counterfactuals haben

```{r}
# model <- lm(Counterfactuals ~ Last_Journaling, data = data)

data_journaling_heute <- data %>% 
  dplyr::select(Selfefficacy, Journaling3, Counterfactuals) %>% 
  na.omit(data$Journaling3)


model1 <- lm(Counterfactuals ~ Journaling3, data = data_journaling_heute)
summary(model1)

```
Es macht keinen Unterschied, wann die Leute zum letzten Mal gejournalt haben -> hier ist der p-value auch nicht signifikant. 


# Gibt es einen Zusammenhang zwischen dem letzten Journaling und der Selbstwirksamkeit? (Also ohne die generelle Dauer?)

```{r}
model2 <- lm(Selfefficacy ~ Journaling3, data = data_journaling_heute)
summary(model2)
```
Journaling heute -> p-value bei 0.03, also < 0.05.




# Gibt es einen Zusammenhang zwischen Schulabschluss und Selbstwirksamkeit?

```{r}
model3 <- lm(Selfefficacy ~ Education, data = data)
summary(model3)
```
 
p-value ist mit 0.143 > 0.05, also nicht signifikant. Das bedeutet, dass der Bildungsstand keinen Einfluss auf die Selbstwirksamkeit hat.


# Selbstwirksamkeit und Alter?

```{r}

model4 <- lm(Selfefficacy ~ Age, data = data)

sink("age_selfefficacy.txt")
print(summary(model4))
sink()
```

p-value < 0.05, also heißt das je älter die Menschen sind, desto selbstwirksamer sind sie


# Zusammenhang Journaling und Bildungsstand?

```{r}
model5 <- lm(Journaling ~ Education, data = data)
sink("journaling_education.txt")
print(summary(model4))
sink()
```
Auch hier p-value > 0.05, also keine Zusammenhang zwischen Journaling und Bildungsniveau. 



# Mediationsanalyse 



```{r}
pfad_a <- lm(Counterfactuals ~ Journaling, data_mediation)
summary(pfad_a)
```
Nicht signifikant, also Journaling führt nicht zu Counterfactuals
```{r}
durbinWatsonTest(pfad_a)

```
 p-value is > 0.05, also sind die residuals nicht autocorrelated (für mehr Infos siehe https://www.statology.org/durbin-watson-test-r/)

```{r}
pfad_b <- lm(Selfefficacy ~ Counterfactuals, data_mediation)
summary(pfad_b)
```

p-value > 0.05, also Counterfactuals führt nicht zu einer stärkeren Selbstwirksamkeit

```{r}
durbinWatsonTest(pfad_b)
```

```{r}
pfad_bc <- lm(Selfefficacy ~ Journaling + Counterfactuals, data_mediation)
summary(pfad_bc)
```

p-value < 0.05 (0.00603), also heißt das, dass Counterfactuals und Journaling zusammen zu mehr Selbstwirksamkeit führen 
Journaling > 0.001 (0.0047), also wirkt es nicht signifikant auf die abhängige Variable Selbstwirksamkeit?
Counterfactuals wirkt nicht signifikant auf Selbstwirksamkeit (0.1956)

```{r}
pfad_c <- lm(Selfefficacy ~ Journaling, data = data_mediation)
summary(pfad_c)
```
p < 0.05, also signifikant. Das ist jetzt aber 
```{r}
durbinWatsonTest(pfad_bc)
```


```{r}
#install.packages("mediation")
library(mediation)
```

```{r}
#stargazer(fit_lm, type = "html", out = "fit_lm.html")
results <- mediate(pfad_a, pfad_bc, treat = "Journaling", mediator = "Counterfactuals", boot = TRUE, sims = 2000)
sum.results <- summary(results)
```




ACME ist der average causal mediation effect und beschreibt den indirekten Pfad (a x b). Er ist nicht signifikant (0.44 p-value).

ADE ist der average direct effect und beschreibt Pfad c, also den direkten Effect von Journaling auf Selbstwirksamkeit. Er ist signifikant (0.002). Dies bedeutet, dass Journaling doch zu Selbstwirksamkeit führt.

Der Total Effect ergibt sich aus Addition von indirektem und direktem Effekt, also ACME + ADE und liegt somit bei 0.001.

Prop. Mediated gibt an, wie hoch der prozentuale Anteil von ACME am Total Effect ist, also wie viel Prozent des Effekts über die Mediation geschieht (44%
)

Anteil, der durch die Mediation erklärt wird, beträgt nur 1,7%



```{r}

#print(xtable(as.table(sum.test), type = "latex"), file = "test.tex")
#print(xtable(as.table(sum.results), type = "latex"), file = "mediationanalysis.tex")

sink("test.txt")
print(sum.results)
sink()
```



```{r}
plot(results)

```

```{r}
data_mediation %>% 
  filter(Education == "Alevels")
```
```{r}
install.packages("corrplot")
```
```{r}
library(corrplot)
```


```{r}

model.matrix(~0+., data=data_mediation %>% dplyr::select(-Journaling, -Counterfactuals, -Age, -Gender, -Selfefficacy)) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot(show.diag=FALSE, type="lower", lab=TRUE, lab_size=3, tl.cex = 10) + 
      theme(plot.title = element_text(size = 20), 
            plot.subtitle = element_text(size = 15), 
            plot.caption = element_text(size = 12)) +
      coord_fixed(ratio = 1) #%>% 
#print(vp=viewport(width=15, height=15)) # Ändere die Breite und Höhe des Plots


# one-hot encoding machen und dann corrplot anstatt gg

```






```{r}
# Schauen, on es passen würde, wenn man sich nur die Upward Counterfactuals anschauen würde 

#data_upward <- data %>% 
#  dplyr::select(7:22) %>% 
#dplyr::select(-1, -5, -9, -13) 

#counterfactual <- grep("Counterfactuals", names(data_upward), value = TRUE)
  
#data_upward$Summe <- rowSums(data_upward[c(counterfactual)])

data_upward <- data %>% 
  dplyr::select(-Journaling2, -7, -11, -15, -19, -Journaling, -Counterfactuals, -Journaling)
  journaling_columns1 <- grep("Journaling", names(data_upward), value = TRUE)
  counterfactual_columns1 <- grep("Counterfactuals", names(data_upward), value = TRUE)
  selfefficacy_columns1 <- grep("Selbstwirksamkeit", names(data_upward), value = TRUE)


data_upward$Journaling <- rowSums(data_upward[c(journaling_columns1)]) 
data_upward$Counterfactuals <- rowSums(data_upward[c(counterfactual_columns1)]) 
data_upward$Selfefficacy <- rowSums(data_upward[c(selfefficacy_columns1)]) 

data_upward

data_upward <- data_upward %>% 
  dplyr::select(Journaling, Counterfactuals, Selfefficacy)

data_upward

```

```{r}
pfad_a1 <- lm(Counterfactuals ~ Journaling, data_upward)
summary(pfad_a1)
```
```{r}
pfad_bc1 <- lm(Selfefficacy ~ Journaling + Counterfactuals, data_upward)
summary(pfad_bc1)
```
```{r}
results1 <- mediate(pfad_a1, pfad_bc1, treat = "Journaling", mediator = "Counterfactuals", boot = TRUE, sims = 2000)
summary(results1)
```
```{r}
qqnorm(data_mediation$Journaling, main = 'Q-Q Plot for Normality - Journaling', xlab = 'Theoretical Dist',
       ylab = 'Sample dist', col = 'steelblue')

qqline(data_mediation$Journaling)

```

```{r}
qqnorm(data_mediation$Counterfactuals, main = 'Q-Q Plot for Normality - Counterfactual Thinking', xlab = 'Theoretical Dist',
       ylab = 'Sample dist', col = 'steelblue')

qqline(data_mediation$Counterfactuals)


```
```{r}
qqnorm(data_mediation$Selfefficacy, main = 'Q-Q Plot for Normality - Self-Efficacy', xlab = 'Theoretical Dist',
       ylab = 'Sample dist', col = 'steelblue')

qqline(data_mediation$Selfefficacy)


```

```{r}
qqnorm(log(data_mediation$Selfefficacy), main = 'Q-Q Plot for Normality - Self-Efficacy', xlab = 'Theoretical Dist',
       ylab = 'Sample dist', col = 'steelblue')

qqline(log(data_mediation$Selfefficacy))
```


```{r}
ad.test(data_mediation$Journaling)

```
==> Journaling folgt keiner Normalverteilung

```{r}
ad.test(data_mediation$Counterfactuals)

```
==> Counterfactuals ist normalverteilt 

```{r}
ad.test(data_mediation$Selfefficacy)

```
==> Self-efficacy ist normalverteilt


```{r}
hist(data_mediation$Journaling, col = 'steelblue', main = 'Distribution of Journaling',
     xlab = 'Journaling Score')
```

==> positively scewed, also muss ich die Daten so verändern, dass eine Normalverteilung entsteht 


```{r}
hist(data_mediation$Counterfactuals, col = 'steelblue', main = 'Distribution of Counterfactual Thinking',
     xlab = 'Counterfactual Thinking Score')
```

```{r}
hist(data_mediation$Selfefficacy, col = 'steelblue', main = 'Distribution of Self-Efficacy',
     xlab = 'Self-Efficacy Score')
```
# Test auf Linear Relationship

```{r}
cor(data_mediation$Counterfactuals, data_mediation$Journaling, use='complete.obs', method = "pearson")
```
```{r}
cor(data_mediation$Journaling + data_mediation$Counterfactuals, data_mediation$Selfefficacy, use='complete.obs', method = "pearson")
```

# Test auf Independence 

```{r}
data_independance <- data_mediation %>% 
  dplyr::select(Journaling, Counterfactuals, Selfefficacy)

data_independance.table = table()

```


```{r}
descriptive_results <- summary(data_independance)

sink("descriptive.txt")
print(descriptive_results)
sink()
```


# Test auf Homoscedasticity

```{r}
gqtest(pfad_a)
```

```{r}
gqtest(pfad_bc)
```

# Explorative Analysis

```{r}
model_journaling_gender <- glm(data_mediation$Journaling ~ data_mediation$Gender, data = data_mediation)


summary(model_journaling_gender)

```

```{r}
journaling_gender <- summary(model_journaling_gender)

sink("journaling_gender.txt")
print(journaling_gender)
sink()
```


```{r}
model_cft_gender <- glm(data_mediation$Counterfactuals ~ data_mediation$Gender, data = data_mediation)



cft_gender <- summary(model_cft_gender)


sink("cft_gender.txt")
print(cft_gender)
sink()
```


```{r}
model_se_gender <- glm(data_mediation$Selfefficacy ~ data_mediation$Gender, data = data_mediation)



se_gender <- summary(model_se_gender)


sink("se_gender.txt")
print(se_gender)
sink()

```


```{r}

model_education_journaling <- glm(data_mediation$Journaling ~ data_mediation$Education, data = data_mediation)

edu_journaling <- summary(model_education_journaling)


sink("edu_journaling.txt")
print(edu_journaling)
sink()


```



```{r}

model_education_age <- glm(data_mediation$Age ~ data_mediation$Education, data = data_mediation)

edu_age <- summary(model_education_age)


sink("edu_age.txt")
print(edu_age)
sink()


```


```{r}

model.matrix(~0+., data=data_gender) %>% 
  cor(use="pairwise.complete.obs") %>% 
  ggcorrplot(show.diag=FALSE, type="lower", lab=TRUE, lab_size=2)
```






